rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
        (
          request.auth.token.email == 'atharv.kuzzboost@gmail.com' || 
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
        );
    }

    // Users can read own data, admins can read all
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Allow create if user doesn't exist
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow update with restrictions
      allow update: if request.auth != null && request.auth.uid == userId && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'balance']));
    }
    
    // Payment requests
    match /payment_requests/{requestId} {
      // Users can create requests for themselves
      allow create: if request.auth != null && request.resource.data.user_id == request.auth.uid;
      
      // Users can read own requests (and query them)
      allow read: if request.auth != null && (resource.data.user_id == request.auth.uid || isAdmin());
      
      // Only admins can update (approve/reject)
      allow update: if isAdmin();
    }
    
    // Balance transactions (Immutable ledger)
    match /balance_transactions/{txId} {
      allow read: if request.auth != null && (resource.data.user_id == request.auth.uid || isAdmin());
      allow create, update: if false;  // Only server (Cloud Functions) can write
    }
    
    // Admin activity log (Immutable audit trail)
    match /admin_activity_log/{logId} {
      allow read: if isAdmin();
      allow create, update: if false;  // Only server can write
    }
  }
}
